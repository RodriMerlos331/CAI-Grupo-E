
no se selecciona CD - OK

buscar dni de fletero q no corresponde a este CD? - no pasa nada, no se contempla

ejemplo: ingreso 44678901 buscar
figuran 1003 y 1004 a rendir y 1008 para generar, si vuelvo a buscar 44678901 no me aparecen para generar más
en el buscar se genera
le doy limpiar
pero si le doy a aceptar se guardan cambios iguales


buscar dni nuevo sin antes guardar anterior
limpiar antes de guardar?
guardar sin cambios?
SAQUÉ MSJS CUANDO NO HAY NUEVAS ENCOMIENDAS PARA GENERAR
SUMÉ GROUP BY 

__

01. san martin andes dni 44678901 busco dos veces: OK
    ya las generadas no me las muestra - BUCAR NO DEBERIA HACER CAMBIOS

    aceptar:

    busco 44678901
    figura 1008 para rendir


02. busco dos veces 44678901 sin darle antes a aceptar y la información es exactamente la misma:
    - le doy aceptar
    - busco de nuevo 44678901
    - HDR 1008 para rendir
    - revisar mensajes cuando no hay nuevas


03. TESTEO GROUPBY:

impongo una en "Agencia Goya Centro", fletero es 42345678,. terminal omnibus goya:

04. BUSCO 44678901(san martin), le doy a limpiar y aceptar:

busco 44678901




____
var fletero = FleteroAlmacen.Fletero
                .FirstOrDefault(f => f.DniFletero == dni);


            if (fletero == null)
            {
                MessageBox.Show("No se encontró un fletero con el DNI ingresado.",
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

            var cdsFletero = fletero.CodCDAsociados;

            var encomiendasRetiro = EncomiendaAlmacen.Encomienda
                .Where(e =>
                    (e.Estado == EstadoEncomiendaEnum.ImpuestaPendienteRetiroDomicilio ||
                     e.Estado == EstadoEncomiendaEnum.ImpuestaPendienteRetiroAgencia)
            && cdsFletero.Contains(e.CodCentroDistribucionOrigen))
                .Select(e => e.Tracking)
                .ToList();

            var encomiendasEntrega = EncomiendaAlmacen.Encomienda
                .Where(e =>
                    (e.Estado == EstadoEncomiendaEnum.PendienteEntregaDomicilio ||
                     e.Estado == EstadoEncomiendaEnum.PendienteEntregaAgencia)
            && cdsFletero.Contains(e.CodCentroDistribucionDestino))
                .Select(e => e.Tracking)
                .ToList();

            
            /*
            foreach (var encomienda in EncomiendaAlmacen.Encomienda
                .Where(e => encomiendasRetiro.Contains(e.Tracking)))
            {
                var estadoPrevio = encomienda.Estado;

                if (estadoPrevio == EstadoEncomiendaEnum.ImpuestaPendienteRetiroDomicilio)
                    encomienda.Estado = EstadoEncomiendaEnum.RuteadaRetiroDomicilio;
                else if (estadoPrevio == EstadoEncomiendaEnum.ImpuestaPendienteRetiroAgencia)
                    encomienda.Estado = EstadoEncomiendaEnum.RuteadaRetiroAgencia;

                encomienda.HistorialCambios.Add(new Historial
                {
                    Tracking = encomienda.Tracking,
                    FechaPrevia = encomienda.FechaImposicion,
                    UbicacionPrevia = null,
                    FleteroAsignado = 0,
                    NumeroHDRUM = 0, 
                    NumeroHDRMD = 0,
                    EstadoPrevio = estadoPrevio
                });
            }
            */

            /* Saco estos mensajes pq son confusos
            if (!encomiendasRetiro.Any())
            {
                MessageBox.Show("No se encontraron encomiendas pendientes de retiro para este fletero.",
                    "Sin retiros", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }

            if (!encomiendasEntrega.Any())
            {
                MessageBox.Show("No se encontraron encomiendas pendientes de entrega para este fletero.",
                    "Sin entregas", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            */

            var hdrGeneradas = new List<HDRDistribucionUMEntidad>();

            int proximoNumeroHDR = HDRDistribucionUMAlmacen.HDRDistribucionUM.Any()
                ? HDRDistribucionUMAlmacen.HDRDistribucionUM.Max(h => h.NumeroHDRUM) + 1
                : 1000;

            //Faltaría Group by retiro = domicilio o agencia??

            if (encomiendasRetiro.Any())
            {
                var hdrRetiro = new HDRDistribucionUMEntidad
                {
                    NumeroHDRUM = proximoNumeroHDR++,
                    Tipo = TipoHDREnum.Retiro,  // 0
                    DniFleteroAsignado = dni,
                    Cumplida = false,
                    Rendida = false,
                    Encomiendas = encomiendasRetiro
                };

                hdrGeneradas.Add(hdrRetiro);
            }

            if (encomiendasEntrega.Any())
            {
                var hdrEntrega = new HDRDistribucionUMEntidad
                {
                    NumeroHDRUM = proximoNumeroHDR++,
                    Tipo = TipoHDREnum.Entrega,  // 1
                    DniFleteroAsignado = dni,
                    Cumplida = false,
                    Rendida = false,
                    Encomiendas = encomiendasEntrega
                };

                hdrGeneradas.Add(hdrEntrega);
            }

            HDRGeneracion = hdrGeneradas.Select(h => new HDR
            {
                Cumplida = false,
                DniTransportista = dniActual,
                Guias = h.Encomiendas
                              .Select(e => EncomiendaAlmacen.Encomienda.Single(en => en.Tracking == e))
                              .Select(e => new Guia
                              {
                                  CodigoGuia = e.Tracking,
                                  Estado = EstadoEquivalenteA(e.Estado),
                                  NumeroHDR = h.NumeroHDRUM
                              }).ToList(),
                NumeroHDR = h.NumeroHDRUM,
                Rendida = false,
                Tipo = TipoEquivalenteA(h.Tipo)
            })
            .ToList();

            return HDRGeneracion;